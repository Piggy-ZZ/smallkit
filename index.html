<!DOCTYPE html>
<html lang="zh">

<head>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;700&display=swap" rel="stylesheet">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å‰µæ–°å˜‰å¹´è¯äººæ•¸çµ±è¨ˆ</title>

    <style>
        body {
            font-family: 'Noto Sans TC', sans-serif;
            background-color: #ffe4e1;
            text-align: center;
        }

        h1 {
            color: #ff69b4;
        }

        h2 {
            color: #ff69b4;
        }

        button {
            padding: 15px 30px;
            font-size: 16px;
            margin: 10px;
            border: none;
            border-radius: 20px;
            background-color: #ffb6c1;
            color: white;
            cursor: pointer;
            transition: background-color 0.3s ease;
        }

        button:hover {
            background-color: #ff69b4;
        }

        #result {
            margin-top: 20px;
            font-size: 20px;
            color: #ff69b4;
        }

        .counter {
            padding: 10px;
            background-color: #fff0f5;
            border-radius: 10px;
            margin: 5px;
        }

        #export {
            margin-top: 20px;
            padding: 10px 20px;
            background-color: #ffa07a;
            color: white;
            border-radius: 15px;
            cursor: pointer;
        }

        #loginContainer {
            margin-top: 100px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }

        label {
            font-size: 22px;
            /* èª¿æ•´å­—é«”å¤§å° */
            margin-bottom: 10px;
        }

        input[type="text"],
        input[type="password"] {
            width: 300px;
            /* èª¿æ•´è¼¸å…¥æ¡†å¯¬åº¦ */
            padding: 10px;
            /* èª¿æ•´å…§é‚Šè·è®“æ¡†è®Šå¤§ */
            font-size: 18px;
            /* èª¿æ•´å­—é«”å¤§å° */
            margin-bottom: 20px;
            /* èª¿æ•´æ¡†èˆ‡æ¡†ä¹‹é–“çš„é–“è· */
            border-radius: 10px;
            border: 1px solid #ccc;
        }

        #appContainer {
            display: none;
        }

        .entry {
            margin: 10px;
            padding: 10px;
            background-color: #fff0f5;
            border-radius: 10px;
        }

        .deleteBtn {
            background-color: red;
            color: white;
            padding: 5px 10px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
        }

        .deleteBtn:hover {
            background-color: darkred;
        }
    </style>

    <!-- å°å…¥ Firebase å’Œ XLSX åº« -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.17.0/xlsx.full.min.js"></script>

    <script>
        let currentUserName = "";
        const validPassword = "0100";

        function login() {
            const username = document.getElementById('username').value;
            const password = document.getElementById('password').value;

            if (password === validPassword) {
                currentUserName = username;
                document.getElementById('loginContainer').style.display = 'none';
                document.getElementById('appContainer').style.display = 'block';
                loadRecentEntries(); // ç™»å…¥å¾ŒåŠ è¼‰æœ€è¿‘ 20 ç­†è³‡æ–™
            } else {
                alert('å¯†ç¢¼éŒ¯èª¤ï¼Œè«‹é‡è©¦ã€‚');
            }
        }
        // ç›£è½éµç›¤äº‹ä»¶ï¼Œç•¶æŒ‰ä¸‹ Enter éµæ™‚åŸ·è¡Œ login å‡½æ•¸
        document.addEventListener('keydown', function (event) {
            if (event.key === 'Enter') {
                login(); // å¦‚æœæŒ‰ä¸‹çš„æ˜¯ Enter éµï¼Œèª¿ç”¨ login å‡½æ•¸
            }
        });
    </script>

    <!-- Firebase é…ç½® -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.14.1/firebase-app.js";
        import { getDatabase, ref, get, set, onValue, push, remove, limitToLast, query } from "https://www.gstatic.com/firebasejs/10.14.1/firebase-database.js";

        const firebaseConfig = {
            apiKey: "YOUR_API_KEY",
            authDomain: "people-counting-1cae9.firebaseapp.com",
            projectId: "people-counting-1cae9",
            storageBucket: "people-counting-1cae9.appspot.com",
            messagingSenderId: "521847124489",
            appId: "1:521847124489:web:bd17765a151b60ccd97ed8",
            databaseURL: "https://people-counting-1cae9-default-rtdb.firebaseio.com"
        };

        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);

        // ç›£è½è¨ªå®¢æ•¸æ“šè®ŠåŒ–
        onValue(ref(db, 'counts'), (snapshot) => {
            const data = snapshot.val();
            document.getElementById('countA').textContent = data['è¿½è¹¤é ˜ğŸ'] || 0;
            document.getElementById('countB').textContent = data['å» å•†åˆä½œ'] || 0;
            document.getElementById('countC').textContent = data['é«”é©—AIKM'] || 0;
            document.getElementById('countD').textContent = data['å®¢æˆ¶è©¢åƒ¹'] || 0;
            document.getElementById('countE').textContent = data['æ±‚è·äººæ‰'] || 0;
        });

        // å¢åŠ è¨ªå®¢é¡å‹ä¸¦è¨˜éŒ„æ“ä½œ
        window.increment = function (type) {
            const countRef = ref(db, 'counts/' + type);
            get(countRef).then((snapshot) => {
                let count = snapshot.val() || 0;
                count++;
                set(countRef, count);

                const timestamp = new Date().toLocaleString();
                const newEntry = {
                    user: currentUserName,
                    type: type,
                    time: timestamp
                };
                push(ref(db, 'recent'), newEntry);
                loadRecentEntries(); // æ›´æ–°æœ€è¿‘æ“ä½œåˆ—è¡¨
            });
        };

        // åŒ¯å‡ºçµ±è¨ˆè³‡æ–™ï¼Œè½‰æ›ç‚º Excel æ ¼å¼
        window.exportData = function () {
            get(ref(db, 'recent')).then((snapshot) => {
                const data = snapshot.val();
                const excelData = [["æ“ä½œæ™‚é–“", "è¨ªå®¢é¡å‹", "æ“ä½œä½¿ç”¨è€…"]];

                Object.keys(data).forEach(key => {
                    const entry = data[key];
                    if (entry.type !== "æ¸…ç©ºæ•¸æ“š") { // ä¸åŒ¯å‡ºæ¸…ç©ºæ•¸æ“šå‰çš„å°å­˜è³‡æ–™
                        excelData.push([entry.time, entry.type, entry.user]);
                    }
                });

                const ws = XLSX.utils.aoa_to_sheet(excelData);
                const wb = XLSX.utils.book_new();
                XLSX.utils.book_append_sheet(wb, ws, "è¨ªå®¢æ“ä½œç´€éŒ„");
                XLSX.writeFile(wb, "visitor_record.xlsx");
            });
        };

        // æ¸…ç©ºæ•¸æ“šä¸¦å°å­˜ recent ä¸­çš„æ‰€æœ‰æ“ä½œï¼Œç„¶å¾Œæ¸…ç©º recent å’Œ counts
        window.clearData = function () {
            const confirmation = confirm("æ‚¨ç¢ºå®šè¦æ¸…ç©ºæ‰€æœ‰æ•¸æ“šå—ï¼Ÿæ­¤æ“ä½œç„¡æ³•æ¢å¾©ã€‚");
            if (confirmation) {
                // å–å¾—ä¸¦å°å­˜ `recent` ä¸­çš„æ‰€æœ‰æ“ä½œåˆ° `archive`
                get(ref(db, 'recent')).then((snapshot) => {
                    const recentData = snapshot.val();
                    const timestamp = new Date().toLocaleString();
                    const archiveEntry = {
                        user: currentUserName,
                        time: timestamp,
                        data: recentData
                    };
                    push(ref(db, 'archive'), archiveEntry); // å°‡å°å­˜æ•¸æ“šæ¨é€åˆ° archive

                    // æ¸…ç©º `recent` ç¯€é»
                    set(ref(db, 'recent'), null);

                    // æ¸…ç©º counts ç¯€é»æ•¸æ“š
                    set(ref(db, 'counts'), {
                        'è¿½è¹¤é ˜ğŸ': 0,
                        'å» å•†åˆä½œ': 0,
                        'é«”é©—AIKM': 0,
                        'å®¢æˆ¶è©¢åƒ¹': 0,
                        'æ±‚è·äººæ‰': 0,
                    });

                    // è¨˜éŒ„æ¸…ç©ºæ“ä½œ
                    const clearEntry = {
                        user: currentUserName,
                        type: "æ¸…ç©ºæ•¸æ“š",
                        time: timestamp
                    };
                    push(ref(db, 'recent'), clearEntry);

                    loadRecentEntries(); // æ›´æ–°æœ€è¿‘æ“ä½œåˆ—è¡¨
                });
            }
        };

        // åŠ è¼‰æœ€è¿‘ 20 ç­†è³‡æ–™ï¼Œä¸åŒ…æ‹¬æ¸…ç©ºæ“ä½œ
        function loadRecentEntries() {
            const recentRef = query(ref(db, 'recent'), limitToLast(20)); // ç²å–æœ€è¿‘ 20 ç­†è³‡æ–™
            get(recentRef).then((snapshot) => {
                const recentData = snapshot.val();
                const recentEntriesDiv = document.getElementById('recentEntries');
                recentEntriesDiv.innerHTML = ''; // æ¸…ç©ºç¾æœ‰å…§å®¹

                Object.keys(recentData).reverse().forEach(key => { // å€’åºé¡¯ç¤º
                    const entry = recentData[key];
                    if (entry.type !== "æ¸…ç©ºæ•¸æ“š") { // ä¸é¡¯ç¤ºæ¸…ç©ºæ•¸æ“šçš„ç´€éŒ„
                        const entryDiv = document.createElement('div');
                        entryDiv.classList.add('entry');
                        entryDiv.innerHTML = `
                            <p>æ™‚é–“: ${entry.time}</p>
                            <p>æ“ä½œä½¿ç”¨è€…: ${entry.user}</p>
                            <p>æ“ä½œé …ç›®: ${entry.type}</p>
                            <button class="deleteBtn" onclick="deleteEntry('${key}', '${entry.type}')">åˆªé™¤</button>
                        `;
                        recentEntriesDiv.appendChild(entryDiv);
                    }
                });
            });
        }

        // åˆªé™¤æŒ‡å®šè³‡æ–™ï¼Œä¸¦å°‡å…¶å°å­˜åˆ° archive
        window.deleteEntry = function (key, type) {
            const confirmation = confirm("æ‚¨ç¢ºå®šè¦åˆªé™¤æ­¤è³‡æ–™å—ï¼Ÿæ­¤æ“ä½œç„¡æ³•æ¢å¾©ã€‚");
            if (confirmation) {
                get(ref(db, 'recent/' + key)).then((snapshot) => {
                    const entry = snapshot.val();
                    const timestamp = new Date().toLocaleString();
                    const archiveEntry = {
                        user: entry.user,
                        time: entry.time,
                        action: entry.type,
                        deletedAt: timestamp,
                        deletedBy: currentUserName // è¨˜éŒ„åˆªé™¤è€…è³‡è¨Š
                    };
                    push(ref(db, 'archive'), archiveEntry); // å°‡åˆªé™¤è³‡æ–™å°å­˜åˆ° archive

                    // åŒæ­¥æ›´æ–° counts æ•¸æ“šï¼Œå°æ‡‰çš„è¨ªå®¢é¡å‹æ¸› 1
                    const countRef = ref(db, 'counts/' + type);
                    get(countRef).then((countSnapshot) => {
                        let count = countSnapshot.val() || 0;
                        count = count > 0 ? count - 1 : 0; // ç¢ºä¿ count ä¸æœƒå°æ–¼ 0
                        set(countRef, count);
                    });
                });

                remove(ref(db, 'recent/' + key)).then(() => {
                    loadRecentEntries(); // åˆªé™¤å¾Œåˆ·æ–°æœ€è¿‘åˆ—è¡¨
                });
            }
        };
    </script>
</head>

<body>

    <!-- ç™»å…¥é é¢ -->
    <div id="loginContainer">
        <h1>ç™»å…¥ä»¥ä½¿ç”¨</h1>
        <label for="username">ä½¿ç”¨è€…</label>
        <input type="text" id="username" required>
        <br>
        <label for="password">å¯†ç¢¼</label>
        <input type="password" id="password" required>
        <br><br>
        <button onclick="login()">ç™»å…¥</button>
    </div>

    <!-- ä¸»é é¢ -->
    <div id="appContainer">
        <h1>å‰µæ–°å˜‰å¹´è¯äººæ•¸çµ±è¨ˆ</h1>

        <!-- å„å€‹è¨ªå®¢é¡å‹çš„æŒ‰éˆ• -->
        <button onclick="increment('è¿½è¹¤é ˜ğŸ')">è¿½è¹¤é ˜ğŸ</button>
        <button onclick="increment('å» å•†åˆä½œ')">å» å•†åˆä½œ</button>
        <button onclick="increment('é«”é©—AIKM')">é«”é©—AIKM</button>
        <button onclick="increment('å®¢æˆ¶è©¢åƒ¹')">å®¢æˆ¶è©¢åƒ¹</button>
        <button onclick="increment('æ±‚è·äººæ‰')">æ±‚è·äººæ‰</button>

        <!-- çµ±è¨ˆçµæœé¡¯ç¤ºå€åŸŸ -->
        <div id="result">
            <div class="counter">è¿½è¹¤é ˜ğŸ: <span id="countA">0</span></div>
            <div class="counter">å» å•†åˆä½œ: <span id="countB">0</span></div>
            <div class="counter">é«”é©—AIKM: <span id="countC">0</span></div>
            <div class="counter">å®¢æˆ¶è©¢åƒ¹: <span id="countD">0</span></div>
            <div class="counter">æ±‚è·äººæ‰: <span id="countE">0</span></div>
        </div>

        <!-- åŒ¯å‡ºçµ±è¨ˆè³‡æ–™æŒ‰éˆ• -->
        <button id="export" onclick="exportData()">åŒ¯å‡ºçµ±è¨ˆè³‡æ–™</button>

        <!-- æ¸…ç©ºæ•¸æ“šæŒ‰éˆ• -->
        <button id="clear" onclick="clearData()">æ¸…ç©ºæ•¸æ“š</button>

        <!-- æœ€è¿‘ 20 ç­†è³‡æ–™ -->
        <h2>æœ€è¿‘ 20 ç­†è³‡æ–™</h2>
        <div id="recentEntries"></div> <!-- é€™è£¡é¡¯ç¤ºæœ€è¿‘ 20 ç­†è³‡æ–™ -->
    </div>

</body>

</html>
